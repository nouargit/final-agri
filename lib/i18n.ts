import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'
import AsyncStorage from '@react-native-async-storage/async-storage'
import * as Localization from 'expo-localization'
import { I18nManager } from 'react-native'

const resources = {
  en: {
    translation: {
      tabs: {
        home: 'Home',
        explore: 'Explore',
        cart: 'Cart',
        shop: 'Shop',
        profile: 'Profile',
      },
      shop: {
        noItems: 'No items found',
        selectShop: 'Select Shop',
        following: 'Following',
        followers: 'Followers',
        likes: 'Likes',
        searchProducts: 'Search products...',
        addCategory: 'Add Category',
        categoryName: 'Category name',
        addCategoryBtn: 'Add Category',
        addCategorySuccess: 'Category added successfully!',
        addCategoryError: 'Failed to add category',
        error: 'Error',
        pleaseSelectShop: 'Please select a shop first',
      },
      addProduct: {
        header: 'Add New Product',
        selectShopLabel: 'Select Shop *',
        productImages: 'Product Images *',
        addPhoto: 'Add Photo',
        basicInformation: 'Basic Information',
        productName: 'Product Name',
        categoryLabel: 'Category *',
        selectShopFirst: 'Select a shop first',
        selectCategory: 'Select Category',
        priceUSD: 'Price (USD)',
        descriptionLabel: 'Description *',
        descriptionPlaceholder: 'Describe your product...',
        nutritionalInformation: 'Nutritional Information',
        calories: 'Calories',
        protein: 'Protein (g)',
        preparationTime: 'Preparation Time (e.g., 15-20 mins)',
        ingredients: 'Ingredients',
        addIngredient: 'Add ingredient',
        allergenInformation: 'Allergen Information',
        selectAllergens: 'Select all allergens that apply to your product',
        addProductBtn: 'Add Product',
        loadingShops: 'Loading shops...',
        errorLoadingShops: 'Error loading shops',
        noShopsAvailable: 'No shops available',
        permissionNeeded: 'Permission needed',
        grantCameraRoll: 'Please grant camera roll permissions to add images.',
        error: 'Error',
        failedPickImage: 'Failed to pick image',
        validationError: 'Validation Error',
        productNameRequired: 'Product name is required',
        productDescriptionRequired: 'Product description is required',
        validPriceRequired: 'Valid price is required',
        categoryRequiredAlert: 'Category is required',
        imageRequired: 'At least one image is required',
        pleaseSelectShopAlert: 'Please select a shop',
        success: 'Success',
        productAddedSuccessfully: 'Product added successfully',
        failedAddProduct: 'Failed to add product',
      },
      profile: {
        title: 'Profile',
        subtitle: 'Manage your account',
        logout: 'Logout',
        logoutConfirm: 'Are you sure you want to logout?',
        cancel: 'Cancel',
        confirmLogout: 'Logout',
        guestUser: 'Guest User',
        noEmail: 'No email',
        memberSince: 'Member since {{date}}',
        orders: 'Orders',
        favorites: 'Favorites',
        inCart: 'In Cart',
        accountSettings: 'Account Settings',
        appNameVersion: 'Sweeta App v1.0.0',
        appTagline: 'Made with ❤️ for sweet lovers',
        menu: {
          editProfile: 'Edit Profile',
          favorites: 'Favorites',
          orderHistory: 'Order History',
          paymentMethods: 'Payment Methods',
          addresses: 'Addresses',
          notifications: 'Notifications',
          help: 'Help & Support',
          about: 'About',
          myShop: 'My Shop',
          myShopSubtitle: 'My Shop',
        },
        language: 'Language',
        english: 'English',
        french: 'Français',
        arabic: 'العربية',
      },
      common: {
        today: 'Today',
        yesterday: 'Yesterday',
        daysAgo: '{{count}} days ago',
        item: 'item',
        items: 'items',
        total: 'total',
        order: 'order',
        cart: 'cart',
      },
      cart: {
        header: 'My Shopping',
        emptyCartTitle: 'Your cart is empty',
        emptyOrdersTitle: 'No orders yet',
        emptyCartDesc: 'Start adding delicious items to your cart and they will appear here',
        emptyOrdersDesc: "Once you place an order, you'll see it here",
        tabCart: 'Cart',
        tabOrders: 'Orders',
        searchPlaceholder: 'Search by shop name...',
        oops: 'Oops! Something went wrong',
        unableToLoad: 'Unable to load your data. Please try again.',
        itemsFound: '{{count}} {{unit}} found',
      },
      bag: {
        noItemsCart: 'No items in this cart',
        noItemsOrder: 'No items in this order',
      },
      orders: {
        loadingSummary: 'Loading cart summary...',
        noSummary: 'No cart summary available',
        loadingCart: 'Loading cart...',
        total: 'Total',
        checkout: 'Checkout',
      },
      product: {
        productDetails: 'Product Details',
        discount: '20% OFF',
        size: 'Size',
        ingredients: 'Ingredients',
        allergensHeader: 'Allergen Information',
        contains: 'Contains {{item}}',
        sellerInfo: 'Seller Information',
        reviewsCount: '{{count}} reviews',
        memberSince: 'Member since {{year}}',
        visitStore: 'Visit Store',
        customerReviews: 'Customer Reviews',
        writeReview: 'Write Review',
        helpful: 'Helpful',
        loadMoreReviews: 'Load More Reviews',
        quantity: 'Quantity',
        addToCartTotal: 'Add to Cart - ${{total}}',
        alertQtyUpdated: 'Item quantity updated in cart!',
        alertAdded: 'Item added to cart successfully!',
        alertAddFailed: 'Failed to add item to cart. Please try again.',
        loadingProduct: 'Loading product...',
        errorLoadingProduct: 'Error loading product',
      },
      training: {
        loadingProducts: 'Loading products...',
        errorLoadingProducts: 'Error loading products',
        categories: 'Categories',
        popularProducts: 'Popular products',
      },
      map: {
        title: 'Shop Location',
        subtitle: "Tap on the map to select your shop's location",
        loadingMap: 'Loading map...',
        permissionDenied: 'Permission to access location was denied',
        errorLocation: 'Error getting your location. Please try again.',
        youAreHere: 'You are here',
        markerTitle: 'Shop Location',
        markerDesc: "This will be your shop's position",
        saveLocation: 'Save Location',
      },
      checkout: {
        deliveryLabel: 'Delivery: {{amount}} DZD',
        totalLabel: 'Total: {{amount}} DZD',
        delivery: 'Delivery',
        pickup: 'Pickup',
        paymentPlaceholder: 'Select payment method',
        order: 'Order',
        loginRequired: 'Please login first',
        successOrder: 'Successful order',
      },
      auth: {
        signIn: 'Sign In',
        signUp: 'Sign Up',
        dontHaveAccount: "Don't have an account?",
        alreadyHaveAccount: 'Already have an account?',
      },
      notFound: {
        oops: 'Oops!',
        message: 'This screen does not exist.',
        goMenu: 'Go to Menu screen!',
      },
    },
  },
  fr: {
    translation: {
      tabs: {
        home: 'Accueil',
        explore: 'Découvrir',
        cart: 'Panier',
        shop: 'Boutique',
        profile: 'Profil',
      },
      profile: {
        title: 'Profil',
        subtitle: 'Gérez votre compte',
        logout: 'Déconnexion',
        logoutConfirm: 'Voulez-vous vraiment vous déconnecter ?',
        cancel: 'Annuler',
        confirmLogout: 'Se déconnecter',
        guestUser: 'Invité',
        noEmail: 'Pas d’e-mail',
        memberSince: 'Membre depuis {{date}}',
        orders: 'Commandes',
        favorites: 'Favoris',
        inCart: 'Dans le panier',
        accountSettings: 'Paramètres du compte',
        appNameVersion: 'Sweeta App v1.0.0',
        appTagline: 'Fait avec ❤️ pour les gourmands',
        menu: {
          editProfile: 'Modifier le profil',
          favorites: 'Favoris',
          orderHistory: 'Historique des commandes',
          paymentMethods: 'Moyens de paiement',
          addresses: 'Adresses',
          notifications: 'Notifications',
          help: 'Aide et support',
          about: 'À propos',
          myShop: 'Ma boutique',
          myShopSubtitle: 'Ma boutique',
        },
        language: 'Langue',
        english: 'Anglais',
        french: 'Français',
        arabic: 'Arabe',
      },
      common: {
        today: 'Aujourd’hui',
        yesterday: 'Hier',
        daysAgo: 'il y a {{count}} jours',
        item: 'article',
        items: 'articles',
        total: 'total',
        order: 'commande',
        cart: 'panier',
      },
      cart: {
        header: 'Mes achats',
        emptyCartTitle: 'Votre panier est vide',
        emptyOrdersTitle: 'Aucune commande pour l’instant',
        emptyCartDesc: 'Ajoutez des articles délicieux à votre panier et ils apparaîtront ici',
        emptyOrdersDesc: 'Une fois que vous passez une commande, elle s’affichera ici',
        tabCart: 'Panier',
        tabOrders: 'Commandes',
        searchPlaceholder: 'Rechercher par nom de boutique...',
        oops: 'Oups ! Une erreur est survenue',
        unableToLoad: 'Impossible de charger vos données. Réessayez.',
        itemsFound: '{{count}} {{unit}} trouvés',
      },
      bag: {
        noItemsCart: 'Aucun article dans ce panier',
        noItemsOrder: 'Aucun article dans cette commande',
      },
      orders: {
        loadingSummary: 'Chargement du résumé du panier...',
        noSummary: 'Aucun résumé de panier disponible',
        loadingCart: 'Chargement du panier...',
        total: 'Total',
        checkout: 'Paiement',
      },
      product: {
        productDetails: 'Détails du produit',
        discount: '20% DE RÉDUCTION',
        size: 'Taille',
        ingredients: 'Ingrédients',
        allergensHeader: 'Informations sur les allergènes',
        contains: 'Contient {{item}}',
        sellerInfo: 'Informations sur le vendeur',
        reviewsCount: '{{count}} avis',
        memberSince: 'Membre depuis {{year}}',
        visitStore: 'Visiter la boutique',
        customerReviews: 'Avis des clients',
        writeReview: 'Rédiger un avis',
        helpful: 'Utile',
        loadMoreReviews: 'Afficher plus d’avis',
        quantity: 'Quantité',
        addToCartTotal: 'Ajouter au panier - ${{total}}',
        alertQtyUpdated: 'Quantité mise à jour dans le panier !',
        alertAdded: 'Article ajouté au panier avec succès !',
        alertAddFailed: 'Échec de l’ajout au panier. Réessayez.',
        loadingProduct: 'Chargement du produit...',
        errorLoadingProduct: 'Erreur de chargement du produit',
      },
      training: {
        loadingProducts: 'Chargement des produits...',
        errorLoadingProducts: 'Erreur de chargement des produits',
        categories: 'Catégories',
        popularProducts: 'Produits populaires',
      },
      map: {
        title: 'Emplacement de la boutique',
        subtitle: 'Touchez la carte pour sélectionner l’emplacement de votre boutique',
        loadingMap: 'Chargement de la carte...',
        permissionDenied: 'Permission d’accès à la localisation refusée',
        errorLocation: 'Erreur lors de la récupération de votre position. Réessayez.',
        youAreHere: 'Vous êtes ici',
        markerTitle: 'Emplacement de la boutique',
        markerDesc: 'Ce sera la position de votre boutique',
        saveLocation: 'Enregistrer l’emplacement',
      },
      checkout: {
        deliveryLabel: 'Livraison : {{amount}} DZD',
        totalLabel: 'Total : {{amount}} DZD',
        delivery: 'Livraison',
        pickup: 'Retrait',
        paymentPlaceholder: 'Sélectionner le mode de paiement',
        order: 'Commander',
        loginRequired: 'Veuillez d’abord vous connecter',
        successOrder: 'Commande réussie',
      },
      auth: {
        signIn: 'Se connecter',
        signUp: 'Créer un compte',
        dontHaveAccount: 'Vous n’avez pas de compte ?',
        alreadyHaveAccount: 'Vous avez déjà un compte ?',
      },
      notFound: {
        oops: 'Oups !',
        message: 'Cet écran n’existe pas.',
        goMenu: 'Aller au menu !',
      },
    },
  },
  ar: {
    translation: {
      tabs: {
        home: 'الرئيسية',
        explore: 'استكشف',
        cart: 'السلة',
        shop: 'المتجر',
        profile: 'الحساب',
      },
      profile: {
        title: 'الحساب',
        subtitle: 'إدارة حسابك',
        logout: 'تسجيل الخروج',
        logoutConfirm: 'هل أنت متأكد أنك تريد تسجيل الخروج؟',
        cancel: 'إلغاء',
        confirmLogout: 'خروج',
        guestUser: 'مستخدم زائر',
        noEmail: 'لا يوجد بريد إلكتروني',
        memberSince: 'عضو منذ {{date}}',
        orders: 'الطلبات',
        favorites: 'المفضلة',
        inCart: 'في السلة',
        accountSettings: 'إعدادات الحساب',
        appNameVersion: 'Sweeta الإصدار 1.0.0',
        appTagline: 'صنع بحب ❤️ لعشاق الحلويات',
        menu: {
          editProfile: 'تعديل الحساب',
          favorites: 'المفضلة',
          orderHistory: 'سجل الطلبات',
          paymentMethods: 'طرق الدفع',
          addresses: 'العناوين',
          notifications: 'الإشعارات',
          help: 'المساعدة والدعم',
          about: 'حول التطبيق',
          myShop: 'متجري',
          myShopSubtitle: 'متجري',
        },
        language: 'اللغة',
        english: 'English',
        french: 'Français',
        arabic: 'العربية',
      },
      common: {
        today: 'اليوم',
        yesterday: 'أمس',
        daysAgo: 'منذ {{count}} يومًا',
        item: 'عنصر',
        items: 'عناصر',
        total: 'المجموع',
        order: 'طلب',
        cart: 'سلة',
      },
      cart: {
        header: 'مشترياتي',
        emptyCartTitle: 'سلتك فارغة',
        emptyOrdersTitle: 'لا توجد طلبات بعد',
        emptyCartDesc: 'ابدأ بإضافة أصناف لذيذة إلى السلة وستظهر هنا',
        emptyOrdersDesc: 'بعد إتمام طلب، سيظهر هنا',
        tabCart: 'السلة',
        tabOrders: 'الطلبات',
        searchPlaceholder: 'ابحث باسم المتجر...',
        oops: 'عذراً! حدث خطأ',
        unableToLoad: 'تعذّر تحميل بياناتك. يرجى المحاولة مرة أخرى.',
        itemsFound: '{{count}} {{unit}}',
      },
      bag: {
        noItemsCart: 'لا توجد عناصر في هذه السلة',
        noItemsOrder: 'لا توجد عناصر في هذا الطلب',
      },
      orders: {
        loadingSummary: 'جارٍ تحميل ملخص السلة...',
        noSummary: 'لا يوجد ملخص للسلة',
        loadingCart: 'جارٍ تحميل السلة...',
        total: 'الإجمالي',
        checkout: 'الدفع',
      },
      product: {
        productDetails: 'تفاصيل المنتج',
        discount: 'خصم 20%',
        size: 'المقاس',
        ingredients: 'المكونات',
        allergensHeader: 'معلومات الحساسية',
        contains: 'يحتوي على {{item}}',
        sellerInfo: 'معلومات البائع',
        reviewsCount: '{{count}} مراجعة',
        memberSince: 'عضو منذ {{year}}',
        visitStore: 'زيارة المتجر',
        customerReviews: 'مراجعات العملاء',
        writeReview: 'اكتب مراجعة',
        helpful: 'مفيد',
        loadMoreReviews: 'عرض المزيد من المراجعات',
        quantity: 'الكمية',
        addToCartTotal: 'أضف إلى السلة - ${{total}}',
        alertQtyUpdated: 'تم تحديث كمية العنصر في السلة!',
        alertAdded: 'تمت إضافة العنصر إلى السلة بنجاح!',
        alertAddFailed: 'فشل في إضافة العنصر إلى السلة. يرجى المحاولة مرة أخرى.',
        loadingProduct: 'جارٍ تحميل المنتج...',
        errorLoadingProduct: 'خطأ في تحميل المنتج',
      },
      training: {
        loadingProducts: 'جارٍ تحميل المنتجات...',
        errorLoadingProducts: 'خطأ في تحميل المنتجات',
        categories: 'الفئات',
        popularProducts: 'المنتجات الشائعة',
      },
      map: {
        title: 'موقع المتجر',
        subtitle: 'اضغط على الخريطة لتحديد موقع متجرك',
        loadingMap: 'جارٍ تحميل الخريطة...',
        permissionDenied: 'تم رفض إذن الوصول إلى الموقع',
        errorLocation: 'حدث خطأ أثناء جلب موقعك. يرجى المحاولة مرة أخرى.',
        youAreHere: 'أنت هنا',
        markerTitle: 'موقع المتجر',
        markerDesc: 'سيكون هذا موقع متجرك',
        saveLocation: 'حفظ الموقع',
      },
      checkout: {
        deliveryLabel: 'التوصيل: {{amount}} دج',
        totalLabel: 'الإجمالي: {{amount}} دج',
        delivery: 'توصيل',
        pickup: 'استلام',
        paymentPlaceholder: 'اختر طريقة الدفع',
        order: 'اطلب',
        loginRequired: 'يرجى تسجيل الدخول أولاً',
        successOrder: 'تم الطلب بنجاح',
      },
      auth: {
        signIn: 'تسجيل الدخول',
        signUp: 'إنشاء حساب',
        dontHaveAccount: 'لا تملك حساباً؟',
        alreadyHaveAccount: 'لديك حساب بالفعل؟',
      },
      notFound: {
        oops: 'عذراً!',
        message: 'هذه الشاشة غير موجودة.',
        goMenu: 'اذهب إلى شاشة القائمة!',
      },
    },
  },
}

const LANGUAGE_KEY = 'app_language'

const mapDeviceLangToApp = (code?: string) => {
  if (!code) return 'en'
  const normalized = code.toLowerCase()
  if (normalized.startsWith('ar')) return 'ar'
  if (normalized.startsWith('fr')) return 'fr'
  return 'en'
}

export const getInitialLanguage = async (): Promise<string> => {
  const stored = await AsyncStorage.getItem(LANGUAGE_KEY)
  if (stored) return stored
  const locales = Localization.getLocales()
  const device = locales && locales.length > 0 ? locales[0].languageCode : 'en'
  return mapDeviceLangToApp(device || 'en')
}

const applyRTLForLanguage = (_lang: string) => {
  // No global force of RTL/LTR. We control direction at the View level.
}

export const initializeI18n = async () => {
  const lang = await getInitialLanguage()
  applyRTLForLanguage(lang)
  await i18n.changeLanguage(lang)
}

export const setAppLanguage = async (lang: 'en' | 'fr' | 'ar') => {
  await AsyncStorage.setItem(LANGUAGE_KEY, lang)
  applyRTLForLanguage(lang)
  await i18n.changeLanguage(lang)
}

export const getDateLocale = (): string => {
  const lang = i18n.language || 'en'
  if (lang === 'fr') return 'fr-FR'
  if (lang === 'ar') return 'ar'
  return 'en-US'
}

i18n
  .use(initReactI18next)
  .init({
    compatibilityJSON: 'v4',
    resources,
    lng: 'en',
    fallbackLng: 'en',
    interpolation: { escapeValue: false },
  })

export default i18n